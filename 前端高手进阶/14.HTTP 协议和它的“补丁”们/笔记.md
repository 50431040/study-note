# HTTP

## HTTP/0.9

协议定义了客户端发起请求、服务端响应请求的通信模式。请求报文内容只有 1 行，为 GET 加上请求的文件路径。服务端收到请求后返回一个以 ASCII 字符流编码的 HTML 文档。

## HTTP/1.0

增加了头部设定，头部内容以键值对的形式设置。请求头部通过 `Accept` 字段来告诉服务端可以接受的文件类型，响应头再通过 `Content-Type` 字段来告诉浏览器返回文件的类型。在此之上能够传输脚本、样式、图片等不同类型的文件。

## HTTP/1.1

- HTTP/1.0 每进行一次通信，都需要经历建立连接、传输数据和断开连接三个阶段，增加了网络开销。

- HTTP/1.1 增加了创建持久连接的方法，一个连接传输完成后，并不是马上关闭，而是继续复用来传输其他请求的数据，直到浏览器或者服务器要求断开连接为止。

### 三次握手

- 第一次握手：客户端处于 CLOSED 状态，服务端处于 LISTEN 状态。客户端给服务端发送一个 SYN 报文，并指明客户端的初始化序列号 ISN，此时客户端处于 SYN_SEND 状态。

- 第二次握手：当服务端收到客户端的 SYN 报文后，会以自己的 SYN 报文作为应答，并且制定自己的初始化序列号 ISN。同时会把客户端的 ISN + 1 作为 ACK 的值，表示已经收到了客户端的 SYN，此时服务端处于 SYN_REVD 状态。

- 第三次握手：当客户端收到 SYN 报文，把服务端的 ISN + 1 作为 ACK 发送给服务端，表示收到了服务端的 SYN 报文，此时客户端处于 ESTABLISHED 状态。服务端收到 ACK 报文后，也处于 ESTABLISHED 状态。此时双方成功建立起了连接。

- 为什么要进行三次握手？第一次握手让服务端知道了客户端具有发送能力，第二次握手让客户端知道了服务端具有接收和发送的能力，此时服务端不知道客户端是否接收到了自己发送的消息，所以第三次握手就起到了作用。

### 四次挥手

- 第一次挥手：客户端发送一个 FIN 报文，用来关闭客户端到服务端的数据传输，此时客户端处于 FIN_WAIT_1 状态。

- 第二次挥手：服务端收到 FIN ，会把客户端的序列号值加 1 作为 ACK 报文的序列号值发送给客户端，表示已经收到，此时服务端处于 CLOSE_WAIT 状态。

- 第三次挥手：如果服务端同意关闭连接，会向客户端发送一个 FIN 报文，并制定一个序列号，此时服务端处于 LAST_ACK 状态。

- 第四次挥手：客户端收到 ACK 后，处于 FIN_WAIT_2 状态。收到 FIN 报文时把服务端的序列号值加 1 作为 ACK 报文的序列号值发送给服务端。此时客户端处于 TIME_WAIT 装填。等待一段时间后进入 CLOSED 状态。当服务端收到 ACK 报文后，也变为 CLOSED 状态。此时连接正式关闭。

- 为什么建立连接只通信了三次，断开需要四次？因为当服务端收到客户端的 FIN 后， ACK 报文只是用来应答，并不表示服务端也希望立即关闭连接。当服务端把所有报文发送完了，才会发送 FIN 报文，告诉客户端可以断开连接了。

## HTTP/2

- HTTP/1.1 虽然通过长连接减少了大量创建/断开连接造成的损耗，但它的并发能力受到限制：浏览器为了减轻服务器的压力，限制了同一个域名下的 HTTP 连接数（6~8），使用多个域名来解决。使用持久连接时，多个请求复用一个 TCP 连接，但是一个连接中同一时刻只能处理一个请求，当前请求没有结束时，其他的请求处于阻塞状态，这种情况称为“队头阻塞”。

- HTTP/2 新增了一个二进制分帧的机制来提高传输效率。默认不再使用 ASCII 编码传世，改用二进制数据。发送请求时将每个请求的内容封装成不同的带有编号的二进制帧，然后将这些帧同时发送给服务端。服务端接收到数据之后，会将相同编号的帧合并为完整的请求信息。同样，服务端返回结果、客户端接收结果也遵循这个帧的拆分和组合的过程。这样，客户端只需要与客户端建立一个连接即可完成通信，不再受限于浏览器的连接数限制，利用一个连接来发送多个请求的方式称为“多路复用”。

## HTTPS

### 对称加密

### 非对称加密

### 证书机制

- 把公钥放入证书中，证书包含服务端的信息，比如颁发者、域名、有效期。为了确保证书是可信的，需要由 CA 对证书进行签名。如何检验证书签名的真假？证书签名就是将证书信息进行 MD5 计算，获取哈希值后利用私钥对其进行加密。校验就是用公钥对签名进行解密，将解密后的 MD5 值与计算所得的 MD5 值进行比对，如果两者一致代表签名是可信的。

- 通过签名来颁发和校验证书的方式会形成一个可追溯的链，即证书链。处于证书链顶端的证书称为根证书，这些根证书被预置在操作系统的内部。

## HTTP/3

HTTP/2 中，客户端或服务端在通信时出现数据包丢失，或者网络出现中断，整个 TCP 连接就会暂停。HTTP/3 将底层依赖的 TCP 改为 UDP，解决了这个问题。UDP 相对 TCP 而言最大的特点是传输数据时不需要建立连接，可以同时发送多个数据包，所以传输效率高，缺点是没有确认机制来保证对方一定能收到数据。

